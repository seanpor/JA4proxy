# {{ ansible_managed }}
# Redis 7 — High-Security Configuration for JA4proxy
# Generated by Ansible redis-secure role

################################ NETWORK ################################

bind {{ redis_bind_address }}
port 0
# All traffic over TLS — plaintext port disabled

protected-mode yes
tcp-backlog 128
timeout 300
tcp-keepalive 60

################################## TLS ##################################

tls-port {{ redis_port }}
tls-cert-file /tls/redis.crt
tls-key-file /tls/redis.key
tls-ca-cert-file /tls/ca.crt

# TLS protocol — only 1.2 and 1.3
tls-protocols "TLSv1.2 TLSv1.3"

# Strong cipher suites only
tls-ciphersuites "TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256"
tls-ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"

{% if redis_mtls_enabled %}
# Mutual TLS — require valid client certificate
tls-auth-clients yes
{% else %}
tls-auth-clients no
{% endif %}

# Replication and cluster also over TLS
tls-replication yes
tls-cluster yes

# Prefer server cipher order
tls-prefer-server-ciphers yes

# Session caching for performance
tls-session-caching yes
tls-session-cache-size 20480
tls-session-cache-timeout 300

################################# ACL ###################################

# Load ACL from external file (managed by Ansible)
aclfile /etc/redis/users.acl

################################ MEMORY #################################

maxmemory {{ redis_maxmemory }}
maxmemory-policy {{ redis_maxmemory_policy }}

############################ PERSISTENCE ################################

{% if redis_aof_enabled %}
# AOF — append-only file (preferred for audit trail)
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
{% else %}
appendonly no
{% endif %}

{% if redis_rdb_enabled %}
# RDB snapshots
save 900 1
save 300 10
save 60 10000
{% else %}
# RDB disabled — AOF provides persistence
save ""
{% endif %}

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes

dir /data

############################# SECURITY ##################################

# Disable dangerous commands completely
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command DEBUG ""
rename-command CONFIG ""
rename-command SHUTDOWN ""
rename-command BGSAVE ""
rename-command BGREWRITEAOF ""
rename-command SLAVEOF ""
rename-command REPLICAOF ""
rename-command MODULE ""
rename-command SCRIPT ""

############################# LOGGING ###################################

loglevel notice
logfile ""

# Slow log — capture queries taking more than 10ms
slowlog-log-slower-than 10000
slowlog-max-len 128

############################# LIMITS ####################################

maxclients 256

# Disable Lua scripting (attack surface reduction)
# lua-time-limit is kept but SCRIPT command is renamed above

######################### LATENCY MONITORING ############################

latency-monitor-threshold 50

####################### ACTIVE DEFRAGMENTATION ##########################

activedefrag no

########################### MISCELLANEOUS ###############################

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Disable potentially dangerous features
enable-debug-command no
