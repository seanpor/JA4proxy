global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries 3

frontend tls_in
    bind *:443
    default_backend ja4proxy_backend
    # TCP mode — TLS stream passes through untouched
    # PROXY protocol v2 sends real client IP to ja4proxy
    option tcplog

frontend http_in
    bind *:80
    mode http
    # Health check endpoint for HAProxy itself
    acl is_health path /haproxy-health
    http-request return status 200 content-type text/plain string "OK" if is_health
    # Forward HTTP traffic to proxy too (for health checks / non-TLS demo)
    default_backend ja4proxy_backend_http

backend ja4proxy_backend
    # TCP passthrough — preserves TLS ClientHello for JA4 fingerprinting
    server proxy1 proxy:8080 send-proxy-v2

backend ja4proxy_backend_http
    mode http
    server proxy1 proxy:8080

frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats show-node
