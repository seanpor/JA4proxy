global
    log stdout format raw local0
    maxconn 4096

    # ── Global TLS defaults (TLS 1.2+ only, no weak ciphers) ──────────
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-bind-ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305

    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphersuites TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305

    # Tune DH param size (2048-bit minimum)
    tune.ssl.default-dh-param 2048

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    retries 3

# ═══════════════════════════════════════════════════════════════════════
# FRONTEND: TLS passthrough (preserves ClientHello for JA4 fingerprinting)
# ═══════════════════════════════════════════════════════════════════════
frontend tls_in
    bind *:443
    default_backend ja4proxy_backend
    # TCP mode — TLS stream passes through untouched to ja4proxy
    # PROXY protocol v2 sends real client IP to ja4proxy
    option tcplog

    # Log TCP connection errors (catches handshake failures at TCP level)
    option dontlog-normal
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"

# ═══════════════════════════════════════════════════════════════════════
# FRONTEND: TLS-terminated admin/management endpoint (TLS 1.2+ enforced)
# ═══════════════════════════════════════════════════════════════════════
frontend tls_managed
    bind *:8443 ssl crt /etc/ssl/certs/haproxy.pem alpn h2,http/1.1
    mode http

    # Log TLS handshake details including failures
    option httplog
    log-format "%ci:%cp [%t] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r sslv:%sslv sslc:%sslc"

    # Health check endpoint
    acl is_health path /haproxy-health
    http-request return status 200 content-type text/plain string "OK" if is_health

    # Reject non-TLS (should never happen on this bind, but defense-in-depth)
    http-request deny unless { ssl_fc }

    # Forward to proxy over HTTP (internal network)
    default_backend ja4proxy_backend_http

frontend http_in
    bind *:80
    mode http
    # Health check endpoint for HAProxy itself
    acl is_health path /haproxy-health
    http-request return status 200 content-type text/plain string "OK" if is_health
    # Forward HTTP traffic to proxy too (for health checks / non-TLS demo)
    default_backend ja4proxy_backend_http

# ═══════════════════════════════════════════════════════════════════════
# BACKENDS
# ═══════════════════════════════════════════════════════════════════════
backend ja4proxy_backend
    # TCP passthrough — preserves TLS ClientHello for JA4 fingerprinting
    server proxy1 proxy:8080 send-proxy-v2

backend ja4proxy_backend_http
    mode http
    server proxy1 proxy:8080

# ═══════════════════════════════════════════════════════════════════════
# BACKEND: TLS to backend with certificate pinning
# Use this backend when HAProxy terminates TLS and re-encrypts to upstream
# ═══════════════════════════════════════════════════════════════════════
backend ja4proxy_backend_mtls
    mode http

    # Verify backend server certificate against our CA
    # ssl     = connect to backend over TLS
    # verify required = reject if cert is invalid or untrusted
    # ca-file = trust anchor — only certs signed by this CA are accepted
    # crt     = client certificate for mutual TLS (backend authenticates HAProxy)
    server proxy1 proxy:8443 ssl verify required ca-file /etc/ssl/certs/ca.crt crt /etc/ssl/certs/haproxy-client.pem

    # Certificate pinning: reject if backend cert doesn't match expected fingerprint
    # Generate fingerprint: openssl x509 -in backend.crt -fingerprint -sha256 -noout
    # Uncomment and set the SHA-256 fingerprint of each backend certificate:
    # http-response deny unless { ssl_s_sha1 abcdef0123456789abcdef0123456789abcdef01 }

# ═══════════════════════════════════════════════════════════════════════
# FRONTEND: Stats dashboard (TLS-secured)
# ═══════════════════════════════════════════════════════════════════════
frontend stats
    bind *:8404 ssl crt /etc/ssl/certs/haproxy.pem
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats show-node

    # Log TLS handshake failures for the stats endpoint
    option httplog
    log-format "%ci:%cp [%t] %ft %ST %B %ts sslv:%sslv sslc:%sslc %{+Q}r"
